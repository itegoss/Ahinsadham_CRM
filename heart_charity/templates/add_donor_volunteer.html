{% extends "base.html" %}
{% block title %}Add Donor / Volunteer{% endblock %}

{% block content %}

<style>
    .card { background: #f2fff4 !important; border-radius: 12px; }
    .card-header { border-radius: 12px 12px 0 0 !important; color: #fff; text-align: center; }
    .form-control, .form-select { border-radius: 8px; border: 1px solid #b5d7b8; transition: 0.2s; }
    .form-control:focus, .form-select:focus { box-shadow: 0 0 6px rgba(13, 122, 52, 0.3); }
    .form-label { font-weight: 600; }
    .btn-success { background: #0d7a34; border: none; border-radius: 8px; transition: 0.3s; font-size: 17px; }
    .btn-success:hover { background: #0a5a27; transform: translateY(-2px); box-shadow: 0px 4px 10px rgba(13, 122, 52, 0.3); }
    hr { border-top: 2px solid #b5d7b8; margin: 6px 0 15px 0; }
    h5.section-title { color: #0d7a34; font-weight: 400; }


    .search-box {
    position: relative;
    width: 100%;
}

.dropdown {
    position: absolute;
    top: 100%;
    width: 100%;
    border: 1px solid #888;
    background: #fff;
    display: none;
    max-height: 180px;
    overflow-y: auto;
    z-index: 999;
}

.dropdown div {
    padding: 8px;
    cursor: pointer;
}

.dropdown div:hover {
    background: #f1f1f1;
}
  

</style>

<div class="container mt-4 mb-5">
    <div class="card shadow-lg border-0">
        <div class="text-center mb-4">
      <h3 class="fw-bold text-success">Add Donor/Volunteer</h3>
      <p class="text-muted">Fill out the details to record a new donation</p>
    </div>
              {% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endfor %}
{% endif %}
        <div class="card-body">
            <form method="POST" action="{% url 'add_donor_volunteer' %}" enctype="multipart/form-data">
                {% csrf_token %}

                <!-- ========================= PERSON TYPE ========================= -->
                <h5 class="text-success fw-bold mb-2">Person Type</h5>
                <hr>
<!-- <div class="row g-3 mb-3 align-items-end">

    <!-- Person Type 
    <div class="col-md-6">
        <label class="form-label fw-semibold">Person Type</label>
        <select name="person_type" id="person_type" class="form-select" required>
            <option value="">-- Select or Type to Search --</option>
            {% for option in person_type_options %}
            <option value="{{ option.id }}">{{ option.lookup_name }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Referred By
    <div class="col-md-6">
        <label class="form-label fw-semibold">Referred By</label>
        <select name="referred_by" class="form-select">
            <option value="">-- Select Person --</option>
            {% for person in all_donors %}
            <option value="{{ person.id }}">
                {{ person.first_name }} {{ person.last_name }}
            </option>
            {% endfor %}
        </select>
    </div>
</div> -->

                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Person Type</label>
                        <select name="person_type" id="person_type" class="form-select" required>
                            <option value="">Select</option>
                             {% for option in person_type_options %}
                            <option value="{{ option.id }}">{{ option.lookup_name }}</option>
                        {% endfor %}
                        </select>
                    </div>

                       <div class="col-md-6">
                        <label class="form-label">Referred By</label>
                       <select name="referred_by" class="form-select">
        <option value="">-- Select Person --</option>
        {% for person in all_donors %}
            <option value="{{ person.id }}">
                {{ person.first_name }} {{ person.last_name }}
            </option>
        {% endfor %}
    </select>
                    </div>


                </div>

<!-- 
                       <div class="row g-3 mb-3">
                    <div class="col-md-6">
                       <select name="person_type" id="person_type" class="form-select" required>
                        <option value="">Select</option>
                        {% for option in person_type_options %}
                            <option value="{{ option.id }}">{{ option.lookup_name }}</option>
                        {% endfor %}
                    </select>
                    </div>
                </div> -->

                <!-- ========================= PERSONAL DETAILS ========================= -->
                <h5 class="text-success fw-bold mb-2">Personal Details</h5>
                <hr>

                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <label class="form-label">First Name</label>
                        <input type="text" name="first_name" class="form-control" required>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Middle Name</label>
                        <input type="text" name="middle_name" class="form-control">
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Last Name</label>
                        <input type="text" name="last_name" class="form-control" required>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Gender</label>
                        <select name="gender" class="form-select" required>
                            <option value="">Select</option>
                            <option>Male</option>
                            <option>Female</option>
                            <option>Other</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Date of Birth</label>
                        <input type="date" name="date_of_birth" id="date_of_birth" class="form-control" required>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Age</label>
                            <input type="number" name="age" id="age" class="form-control" readonly>                     </div>

                    <div class="col-md-4">
                        <label class="form-label">Blood Group</label>
                        <select name="blood_group" class="form-select" required>
                            <option value="">Select</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                <label class="form-label">Contact Number</label>
                <div class="input-group">
                    <span class="input-group-text">+91</span>
                    <input type="text" name="contact_number" class="form-control" required>
                </div>
            </div>

                    <div class="col-md-4">
                        <label class="form-label">WhatsApp Number</label>
                         <div class="input-group">
                    <span class="input-group-text">+91</span>
                    <input type="text" name="whatsapp_number" class="form-control" required>
                </div>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Email</label>
                        <input type="email" name="email" class="form-control" required>
                    </div>

                    <!-- Donor Box ID -->
                    <div class="col-md-4" id="donor_box_id_row1">
    <label class="form-label">Donor Box</label>
    <select name="donor_box" class="form-select">
    <option value="">Select Donor Box</option>
    {% for box in donation_boxes %}
        <option value="{{ box.id }}">{{ box.donation_id }}</option>
    {% endfor %}
</select>

</div>

                </div>

                <!-- ========================= ADDRESS DETAILS ========================= -->
                <h5 class="text-success fw-bold mb-2">Address Details</h5>
                <hr>
                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <label class="form-label">House Number</label>
                        <input type="text" name="house_number" class="form-control" required>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Building Name</label>
                        <input type="text" name="building_name" class="form-control">
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Landmark</label>
                        <input type="text" name="landmark" class="form-control">
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Area</label>
                        <input type="text" name="area" class="form-control">
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">City</label>
                        <input type="text" name="city" class="form-control" required>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">State</label>
                        <input type="text" name="state" class="form-control" required>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Country</label>
                        <input type="text" name="country" value="India" class="form-control">
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Postal Code</label>
                        <input type="text" name="postal_code" class="form-control" required>
                    </div>

                    <!-- Native Place last -->
                    <div class="col-md-4">
                        <label class="form-label">Native Place</label>
                        <input type="text" name="native_place" class="form-control">
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Native Postal Code</label>
                        <input type="text" name="native_postal_code" class="form-control">
                    </div>
                </div>

                <!-- ========================= ID & PAN DETAILS ========================= -->
                <h5 class="text-success fw-bold mb-2">ID & PAN Details</h5>
                <hr>
                <div class="row g-3 mb-3">
    <div class="col-md-6">
        <label class="form-label">ID Type</label>
        <select name="id_type" id="id_type" class="form-select" required>
            <option value="">Select</option>

            {% for option in id_type_options %}
                <option value="{{ option.id }}">{{ option.lookup_name }}</option>
            {% endfor %}
        </select>
    </div>
</div>

                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label class="form-label">ID Number</label>
                        <input type="text" name="id_number" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">ID Proof Image</label>
                        <input type="file" name="id_proof_image" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">PAN Number</label>
                        <input type="text" name="pan_number" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">PAN Card Image</label>
                        <input type="file" name="pan_card_image" class="form-control">
                    </div>
                </div>
      

 <div class="text-center mt-4">
        <button type="submit" class="btn btn-success px-5 me-3" style="border-radius: 8px;">
          <i class="bi bi-save"></i> Save
        </button>

        <a href="{% url 'welcome' %}?tab=Donation Module" class="btn btn-secondary px-5" style="border-radius: 8px;">
  ‚Üê Back
</a>
      </div>
            </form>
        </div>
    </div>
</div>
<script>
    $(document).ready(function() {
        $('#person_type').select2({
            placeholder: "Select or Type to Search",
            allowClear: true
        });
    });
</script>

<script>


    
const searchInput = document.getElementById("personTypeSearch");
const dropdown = document.getElementById("dropdown_person_type");
const hiddenSelect = document.getElementById("person_type");

// Create array from Django FK data
const items = {{ person_type_options_json | safe }};

searchInput.addEventListener("input", function () {
    const value = this.value.toLowerCase();

    dropdown.innerHTML = "";

    if (!value) {
        dropdown.style.display = "none";
        return;
    }

    const filtered = items.filter(item => item.name.toLowerCase().includes(value));

    filtered.forEach(item => {
        const div = document.createElement("div");
        div.textContent = item.name;

        div.onclick = () => {
            searchInput.value = item.name;
            hiddenSelect.value = item.id;   // set selected ID for form submit
            dropdown.style.display = "none";
        };

        dropdown.appendChild(div);
    });

    dropdown.style.display = filtered.length ? "block" : "none";
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const personType = document.getElementById("person_type");
    const donorBoxRow = document.getElementById("donor_box_id_row");
    const donorBoxOwnerId = "{{ donor_box_owner_id }}"; // Pass this from view
    if(personType && donorBoxRow) {
        donorBoxRow.style.display = "none";
        personType.addEventListener("change", function() {
            donorBoxRow.style.display = (this.value === donorBoxOwnerId) ? "block" : "none";
        });
    }

    const dobInput = document.getElementById("date_of_birth");
    const ageInput = document.getElementById("age");
    if(dobInput && ageInput) {
        dobInput.addEventListener("change", function() {
            const dob = new Date(this.value);
            const today = new Date();
            let age = today.getFullYear() - dob.getFullYear();
            const m = today.getMonth() - dob.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) { age--; }
            ageInput.value = age;
        });
    }
});
</script>

{% endblock %}
